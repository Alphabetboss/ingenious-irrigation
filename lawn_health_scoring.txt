import cv2
import numpy as np

def calculate_vari_score(image_path):
    # Load the image
    img = cv2.imread(image_path)
    if img is None:
        raise FileNotFoundError(f"Image not found: {image_path}")

    # Convert to float for division
    img = img.astype(np.float32)

    # Split into channels
    B, G, R = cv2.split(img)

    # Compute VARI (Greenness Score)
    denominator = (G + R - B)
    denominator[denominator == 0] = 1e-5  # prevent division by zero

    vari = (G - R) / denominator

    # Normalize to 0â€“1 range
    vari_normalized = cv2.normalize(vari, None, 0, 1, cv2.NORM_MINMAX)

    # Compute average greenness score
    avg_score = float(np.mean(vari_normalized))

    return avg_score, vari_normalized

if __name__ == "__main__":
    image_file = "test_lawn.jpg"  # replace with your test image
    score, vari_map = calculate_vari_score(image_file)

    print(f"\nðŸŒ± Greenness Score: {score:.3f} (0=dry/dead, 1=very green)\n")

    # Optional: Show the VARI heatmap
    heatmap = (vari_map * 255).astype(np.uint8)
    color_map = cv2.applyColorMap(heatmap, cv2.COLORMAP_JET)
    cv2.imshow("Greenness Heatmap", color_map)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
